<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Repair NYC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      body {
        margin: 0;
        font-family: "Inter", sans-serif;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
      .legend {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        font-size: 14px;
        z-index: 1000;
      }
      .legend label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="legend">
      <label><input type="checkbox" id="repair-spots" checked /> Repair Spots</label>
      <label><input type="checkbox" id="needs-repair" checked /> Needs Repair</label>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyC-GU-gNA_RCHW7xLMyqesJqJBOelFad0s",
        authDomain: "repair-map.firebaseapp.com",
        projectId: "repair-map",
        storageBucket: "repair-map.appspot.com",
        messagingSenderId: "852022779015",
        appId: "1:852022779015:web:70a56c0e6d00de6ae1b1c8"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const map = L.map("map").setView([40.7128, -74.006], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // Add geocoder search control
      const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false
      })
        .on('markgeocode', function(e) {
          const bbox = e.geocode.bbox;
          const poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
          ]).addTo(map);
          map.fitBounds(poly.getBounds());
        })
        .addTo(map);

      const repairIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/1006/1006555.png",
        iconSize: [25, 25],
        iconAnchor: [12, 25],
        popupAnchor: [0, -25]
      });

      const needsRepairIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/1006/1006555.png",
        iconSize: [25, 25],
        iconAnchor: [12, 25],
        popupAnchor: [0, -25]
      });

      const repairSpotsLayer = L.layerGroup().addTo(map);
      const needsRepairLayer = L.layerGroup().addTo(map);

      function loadMarkers() {
        db.collection("points").get().then(querySnapshot => {
          querySnapshot.forEach(doc => {
            const data = doc.data();
            const marker = L.marker([data.lat, data.lng], {
              icon: data.type === "repair" ? repairIcon : needsRepairIcon
            })
              .bindPopup(`<b>${data.title}</b><br>${data.description}`);

            if (data.type === "repair") {
              marker.addTo(repairSpotsLayer);
            } else {
              marker.addTo(needsRepairLayer);
            }
          });
        });
      }

      loadMarkers();

      document.getElementById("repair-spots").addEventListener("change", function () {
        if (this.checked) {
          map.addLayer(repairSpotsLayer);
        } else {
          map.removeLayer(repairSpotsLayer);
        }
      });

      document.getElementById("needs-repair").addEventListener("change", function () {
        if (this.checked) {
          map.addLayer(needsRepairLayer);
        } else {
          map.removeLayer(needsRepairLayer);
        }
      });
    </script>
  </body>
</html>
