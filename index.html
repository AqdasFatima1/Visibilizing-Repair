<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visibilizing Repair</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Urbanist', sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100vh;
        }
        .search-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0px 0px 5px rgba(0,0,0,0.2);
            width: 300px;
        }
        .layer-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0px 0px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="search-bar">
    <input type="text" id="search" placeholder="Search for an address..."/>
</div>

<div id="map"></div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    // Create Map
    const map = L.map('map', {
        center: [40.7128, -74.0060], // Default NYC Center
        zoom: 12,
        layers: [L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        })]
    });

    // Define Warm Tone for Map
    const warmTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        style: {
            color: 'rgb(255, 250, 240)' // Light beige color for map background
        }
    }).addTo(map);

    // Function to Create Circle Marker (Instead of Custom Icon)
    function createMarker(lat, lng, description) {
        const marker = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: '#ff6347',  // Warm orange-red color
            color: '#ff6347',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.6
        })
        .bindPopup(`<b>${description}</b>`)
        .addTo(map);
    }

    // Fetch Markers from Firebase
    function loadMarkers() {
        db.ref('markers').once('value', snapshot => {
            const markers = snapshot.val();
            if (markers) {
                for (const key in markers) {
                    const { lat, lng, description } = markers[key];
                    createMarker(lat, lng, description);
                }
            }
        });
    }

    loadMarkers();  // Load existing markers on page load

    // Search Bar Functionality (Geocoding)
    document.getElementById('search').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            const query = this.value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        const loc = data[0];
                        map.setView([loc.lat, loc.lon], 16);  // Zoom into the searched location
                    } else {
                        alert("Location not found.");
                    }
                })
                .catch(err => {
                    console.error("Error fetching location:", err);
                });
        }
    });

    // Add New Marker
    map.on('click', function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        const description = prompt("Enter a description for the marker:");
        if (description) {
            createMarker(lat, lng, description);

            // Save Marker to Firebase
            db.ref('markers').push({
                lat: lat,
                lng: lng,
                description: description
            });
        }
    });

    // Layer Toggle Functionality
    const repairLayer = L.layerGroup().addTo(map);
    const needRepairLayer = L.layerGroup().addTo(map);

    // Toggle Layers Visibility
    const layerControl = L.control.layers(null, {
        "Repair Locations": repairLayer,
        "Needs Repair": needRepairLayer
    }).addTo(map);
</script>

</body>
</html>
