<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visibilizing Repair Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Urbanist', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            height: 100vh;
        }
        .leaflet-control-layers label {
            font-family: 'Urbanist', sans-serif;
            font-size: 1.2em;
        }
        .leaflet-popup-content {
            font-family: 'Urbanist', sans-serif;
        }
        .search-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .leaflet-control-layers-toggle {
            font-size: 18px;
        }
    </style>
</head>
<body>

    <div class="search-bar">
        <input id="search-input" type="text" placeholder="Search address..." />
    </div>

    <div id="map"></div>

    <!-- Firebase SDK (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // Firebase config
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        // Create map and set initial view
        var map = L.map('map').setView([40.7128, -74.0060], 12); // Set to New York City, change as needed

        // Add tile layer with warm beige tone
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            minZoom: 10,
            maxZoom: 18
        }).addTo(map);

        // Initialize geocoder for the search bar
        var geocoder = L.Control.Geocoder.nominatim();

        // Search functionality
        document.getElementById('search-input').addEventListener('input', function() {
            var query = this.value;
            if (query.length >= 3) {
                geocoder.geocode(query, function(results) {
                    if (results && results.length > 0) {
                        var latlng = results[0].center;
                        map.setView(latlng, 12);
                        L.marker(latlng).addTo(map)
                            .bindPopup(results[0].name)
                            .openPopup();
                    }
                });
            }
        });

        // Toggle layers control
        var repairLayer = L.layerGroup();
        var infrastructureLayer = L.layerGroup();

        // Example marker data from Firebase (replace with your own data)
        var repairRef = db.ref('repairs');
        repairRef.once('value', function(snapshot) {
            snapshot.forEach(function(childSnapshot) {
                var data = childSnapshot.val();
                var lat = data.lat;
                var lng = data.lng;
                var title = data.title;
                var description = data.description;

                var marker = L.marker([lat, lng])
                    .bindPopup('<h3>' + title + '</h3><p>' + description + '</p>');
                repairLayer.addLayer(marker);
            });
        });

        var infrastructureRef = db.ref('infrastructure');
        infrastructureRef.once('value', function(snapshot) {
            snapshot.forEach(function(childSnapshot) {
                var data = childSnapshot.val();
                var lat = data.lat;
                var lng = data.lng;
                var title = data.title;
                var description = data.description;

                var marker = L.marker([lat, lng])
                    .bindPopup('<h3>' + title + '</h3><p>' + description + '</p>');
                infrastructureLayer.addLayer(marker);
            });
        });

        // Add layers control
        L.control.layers({}, {
            "Repairs": repairLayer,
            "Infrastructure": infrastructureLayer,
            "Both": L.layerGroup([repairLayer, infrastructureLayer])
        }).addTo(map);

        // Add the layers to the map
        repairLayer.addTo(map);
        infrastructureLayer.addTo(map);

    </script>
</body>
</html>
