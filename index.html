<!DOCTYPE html>
<html>
<head>
  <title>Repair Mapping Project</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    #map {
      height: 100vh;
      width: 100%;
      font-family: 'Urbanist', sans-serif;
    }

    .leaflet-control-layers {
      font-size: 14px;
    }

    .custom-popup {
      font-family: 'Urbanist', sans-serif;
      font-size: 14px;
      line-height: 1.5;
      max-width: 250px;
    }

    input, textarea, select {
      font-family: 'Urbanist', sans-serif;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
    }

    button {
      margin-top: 8px;
      padding: 6px 12px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #222;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const map = L.map('map').setView([40.7128, -74.0060], 12);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB contributors',
      className: 'leaflet-warm-toned',
    }).addTo(map);

    const repairIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Map_marker_green.svg/512px-Map_marker_green.svg.png',
      iconSize: [32, 48],
      iconAnchor: [16, 48],
      popupAnchor: [0, -30]
    });

    const needRepairIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Map_marker_orange.svg/512px-Map_marker_orange.svg.png',
      iconSize: [32, 48],
      iconAnchor: [16, 48],
      popupAnchor: [0, -30]
    });

    const repairLayer = L.layerGroup();
    const needRepairLayer = L.layerGroup();

    db.collection("markers").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const popupContent = 
          `<div class='custom-popup'>
            <strong>${data.title}</strong><br>${data.description}
            ${data.image ? `<br><img src="${data.image}" width="100%" style="margin-top: 6px; border-radius: 6px;" />` : ""}
          </div>`;
        
        const icon = data.type === "repair" ? repairIcon : needRepairIcon;
        const marker = L.marker([data.lat, data.lng], { icon }).bindPopup(popupContent);

        if (data.type === "repair") {
          marker.addTo(repairLayer);
        } else {
          marker.addTo(needRepairLayer);
        }
      });
    });

    repairLayer.addTo(map);
    needRepairLayer.addTo(map);

    const overlays = {
      "<img src='https://via.placeholder.com/18/28a745/28a745?text=+' style='vertical-align:middle;margin-right:6px;'>Repairs are Happening Here": repairLayer,
      "<img src='https://via.placeholder.com/18/fd7e14/fd7e14?text=+' style='vertical-align:middle;margin-right:6px;'>Repairs are Needed Here": needRepairLayer,
    };

    L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    map.on('click', function (e) {
      const formPopup = L.popup()
        .setLatLng(e.latlng)
        .setContent(
          `<div style="font-family: Urbanist, sans-serif; font-size: 14px;">
            <label>Type: 
              <select id="marker-type">
                <option value="repair">Something is Being Repaired Here!</option>
                <option value="need">Something Needs Repair Here!</option>
              </select>
            </label><br><br>
            <label>Title:<br><input id="marker-title" type="text" /></label><br><br>
            <label>Description:<br><textarea id="marker-description" rows="3"></textarea></label><br><br>
            <label>Image URL (optional):<br><input id="marker-image" type="text" /></label><br><br>
            <button onclick="submitMarker(${e.latlng.lat}, ${e.latlng.lng})">Submit</button>
          </div>`
        )
        .openOn(map);
    });

    function submitMarker(lat, lng) {
      const type = document.getElementById('marker-type').value;
      const title = document.getElementById('marker-title').value;
      const description = document.getElementById('marker-description').value;
      const image = document.getElementById('marker-image').value;

      if (!title || !description) {
        alert("Please enter both a title and description.");
        return;
      }

      const popupContent = 
        `<div class='custom-popup'>
          <strong>${title}</strong><br>${description}
          ${image ? `<br><img src="${image}" width="100%" style="margin-top: 6px; border-radius: 6px;" />` : ""}
        </div>`;

      db.collection("markers").add({
        lat,
        lng,
        title,
        description,
        image,
        type
      }).then(() => {
        const newMarker = L.marker([lat, lng], { icon: type === "repair" ? repairIcon : needRepairIcon })
          .bindPopup(popupContent);
        if (type === "repair") {
          newMarker.addTo(repairLayer);
        } else {
          newMarker.addTo(needRepairLayer);
        }
        map.closePopup();
      });
    }

    // Working search bar with Nominatim
    L.Control.geocoder({
      defaultMarkGeocode: true,
      geocoder: L.Control.Geocoder.nominatim(),
      position: 'topright',
      placeholder: 'Search for places'
    }).addTo(map);
  </script>
</body>
</html>
